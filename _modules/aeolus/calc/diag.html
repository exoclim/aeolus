<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">

    <link rel="shortcut icon" href="../../../_static/favicon.ico"><!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>aeolus.calc.diag - aeolus 26.1.6.0.dev75 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">aeolus 26.1.6.0.dev75 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">aeolus 26.1.6.0.dev75 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples/index.html">Examples</a><input aria-label="Toggle navigation of Examples" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/00_Constants.html">Physical constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/01_Loading_Data.html">Working with model output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/02_Model_Field_Names.html">Model variable names</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/03_Transmission_Spectrum.html">Working with synthetic observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/04_Rotational_And_Divergent_Winds.html">A primer on calculating rotational and divergent wind components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/05_Postprocessing_LFRic.html">Getting LFRic output on a rectiliniear lat-lon grid</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api/index.html">API reference</a><input aria-label="Toggle navigation of API reference" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/calc.html">Science calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core.html">Core hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/const.html">Physical constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/coord.html">Cube coordinate functionality</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/io.html">I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/lfric.html">Functions for LFRic output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/log.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model.html">Model-specific dictionaries of variable and coordinate names</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/plot.html">Plotting functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/proc_um_output.html">Process output of the UM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/region.html">Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/subset.html">Subset cubes using constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/synthobs.html">Synthetic observations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributorâ€™s Guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for aeolus.calc.diag</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Some commonly used diagnostics in atmospheric science.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cf_units</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iris.analysis.calculus</span><span class="w"> </span><span class="kn">import</span> <span class="n">_coord_cos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iris.analysis.maths</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">apply_ufunc</span><span class="p">,</span> <span class="n">multiply</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iris.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConstraintMismatchError</span> <span class="k">as</span> <span class="n">ConMisErr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">iris.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..const</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_const</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">coord_to_cube</span><span class="p">,</span> <span class="n">ensure_bounds</span><span class="p">,</span> <span class="n">regrid_3d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArgumentError</span><span class="p">,</span> <span class="n">MissingCubeError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..meta</span><span class="w"> </span><span class="kn">import</span> <span class="n">const_from_attrs</span><span class="p">,</span> <span class="n">preserve_shape</span><span class="p">,</span> <span class="n">update_metadata</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..model</span><span class="w"> </span><span class="kn">import</span> <span class="n">um</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..subset</span><span class="w"> </span><span class="kn">import</span> <span class="n">_dim_constr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.calculus</span><span class="w"> </span><span class="kn">import</span> <span class="n">d_dz</span><span class="p">,</span> <span class="n">integrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">cumsum</span><span class="p">,</span> <span class="n">spatial_mean</span><span class="p">,</span> <span class="n">time_mean</span><span class="p">,</span> <span class="n">zonal_mean</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;air_density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;air_potential_temperature&quot;</span><span class="p">,</span>
    <span class="s2">&quot;air_pressure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;air_temperature&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bond_albedo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;calc_derived_cubes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dry_lapse_rate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;flux&quot;</span><span class="p">,</span>
    <span class="s2">&quot;geopotential_height&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ghe_norm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;greenhouse_effect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;heat_redist_eff&quot;</span><span class="p">,</span>
    <span class="s2">&quot;horiz_wind_cmpnts&quot;</span><span class="p">,</span>
    <span class="s2">&quot;meridional_mass_streamfunction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;precip_sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sfc_net_energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sfc_water_balance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sigma_p&quot;</span><span class="p">,</span>
    <span class="s2">&quot;toa_cloud_radiative_effect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;toa_eff_temp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;toa_net_energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;water_path&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wind_rot_div&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wind_speed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zonal_mass_streamfunction&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_precip_name_mapping</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate lists of variable names for `precip_sum()`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ls_rain</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ls_snow</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cv_rain</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cv_snow</span><span class="p">],</span>
        <span class="s2">&quot;conv&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">cv_rain</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cv_snow</span><span class="p">],</span>
        <span class="s2">&quot;stra&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ls_rain</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ls_snow</span><span class="p">],</span>
        <span class="s2">&quot;rain&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ls_rain</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cv_rain</span><span class="p">],</span>
        <span class="s2">&quot;snow&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ls_snow</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cv_snow</span><span class="p">],</span>
    <span class="p">}</span>


<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cos_lat&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">lat_cos</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert the latitude coordinate to a cube and apply cosine to it.&quot;&quot;&quot;</span>
    <span class="n">lat_cube</span> <span class="o">=</span> <span class="n">coord_to_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lat_cos_cube</span> <span class="o">=</span> <span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">,</span> <span class="n">lat_cube</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lat_cos_cube</span>


<div class="viewcode-block" id="air_temperature">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.air_temperature">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">air_temperature</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the real temperature from the given cube list.</span>

<span class="sd">    If not present, it is attempted to calculate it from other variables,</span>
<span class="sd">    Exner pressure or air pressure, and potential temperature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing temperature.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have `reference_surface_pressure` and `dry_air_gas_constant`.</span>
<span class="sd">        If not given, an attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of air temperature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thta</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">thta</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to get air temperature from </span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exner</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">exner</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">const</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const</span> <span class="o">=</span> <span class="n">thta</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;planet_conf&quot;</span><span class="p">]</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
            <span class="n">exner</span> <span class="o">=</span> <span class="p">(</span><span class="n">pres</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">reference_surface_pressure</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">dry_air_gas_constant</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">dry_air_spec_heat_press</span>
            <span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to get air temperature from </span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">thta</span> <span class="o">*</span> <span class="n">exner</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp</span></div>



<div class="viewcode-block" id="air_potential_temperature">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.air_potential_temperature">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">air_potential_temperature</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the potential temperature from the given cube list.</span>

<span class="sd">    If not present, it is attempted to calculate it from other variables,</span>
<span class="sd">    Exner pressure or air pressure, and real temperature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing temperature.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have `reference_surface_pressure` and `dry_air_gas_constant`.</span>
<span class="sd">        If not given, an attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of air potential temperature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">thta</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to get air potential temperature from </span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exner</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">exner</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">const</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;planet_conf&quot;</span><span class="p">]</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
            <span class="n">exner</span> <span class="o">=</span> <span class="p">(</span><span class="n">pres</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">reference_surface_pressure</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">dry_air_gas_constant</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">dry_air_spec_heat_press</span>
            <span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to get air potential temperature from </span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">thta</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="n">exner</span>
        <span class="n">thta</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">thta</span><span class="p">)</span>
        <span class="n">thta</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thta</span></div>



<div class="viewcode-block" id="air_pressure">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.air_pressure">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;Pa&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">air_pressure</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get pressure from the given cube list.</span>

<span class="sd">    If not present, it is attempted to calculate it from other variables,</span>
<span class="sd">    such as Exner pressure or air potential temperature and real temperature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing related variables.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have `reference_surface_pressure` and `dry_air_gas_constant`.</span>
<span class="sd">        If not given, an attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of air pressure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exner</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exner</span><span class="p">)</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">reference_surface_pressure</span>
                <span class="o">*</span> <span class="n">exner</span>
                <span class="o">**</span> <span class="p">(</span>
                    <span class="n">const</span><span class="o">.</span><span class="n">dry_air_spec_heat_press</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">dry_air_gas_constant</span>
                <span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">thta</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">exner</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="n">thta</span>
                <span class="n">pres</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">const</span><span class="o">.</span><span class="n">reference_surface_pressure</span>
                    <span class="o">*</span> <span class="n">exner</span>
                    <span class="o">**</span> <span class="p">(</span>
                        <span class="n">const</span><span class="o">.</span><span class="n">dry_air_spec_heat_press</span>
                        <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">dry_air_gas_constant</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to calculate air pressure from </span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">pres</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pres</span></div>



<div class="viewcode-block" id="air_density">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.air_density">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;kg m-3&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">air_density</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get air density from the given cube list.</span>

<span class="sd">    If not present, try to calculate it from pressure and temperature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing temperature.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have `dry_air_gas_constant` as an attribute.</span>
<span class="sd">        If not given, an attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of air density.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">pres</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">const</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const</span> <span class="o">=</span> <span class="n">pres</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;planet_conf&quot;</span><span class="p">]</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">pres</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">dry_air_gas_constant</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>
            <span class="n">rho</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rho</span>
        <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
            <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to get variables from</span><span class="se">\n</span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">to calculate air density&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="calc_derived_cubes">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.calc_derived_cubes">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_derived_cubes</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate additional variables.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">air_temperature</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">const</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">thta</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">air_potential_temperature</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">const</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">air_pressure</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">const</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">air_density</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">const</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ghgt</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="n">cubelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">geopotential_height</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">const</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="geopotential_height">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.geopotential_height">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;m2 s-2&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">geopotential_height</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get geopotential height from the given cube list.</span>

<span class="sd">    If not present, the altitude coordinate is transformed into a cube.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing temperature.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have `gravity` as an attribute.</span>
<span class="sd">        If not given, an attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of geopotential height.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ghgt</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cube_w_height</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">_dim_constr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">const</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const</span> <span class="o">=</span> <span class="n">cube_w_height</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;planet_conf&quot;</span><span class="p">]</span>
            <span class="n">g_hgt</span> <span class="o">=</span> <span class="n">coord_to_cube</span><span class="p">(</span><span class="n">cube_w_height</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">gravity</span>
            <span class="n">g_hgt</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cube_w_height</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;STASH&quot;</span>
            <span class="p">}</span>
            <span class="n">ensure_bounds</span><span class="p">(</span><span class="n">g_hgt</span><span class="p">,</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
            <span class="n">g_hgt</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ghgt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">g_hgt</span>
        <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
            <span class="n">_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No cubes in </span><span class="se">\n</span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="se">\n</span><span class="s2">with </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="si">}</span><span class="s2"> as a coordinate.&quot;</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="flux">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.flux">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flux</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">weight_by_density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate horizontal or vertical flux of some quantity.</span>

<span class="sd">    .. math::</span>
<span class="sd">        F_{x} = u (\rho q),</span>
<span class="sd">        F_{y} = v (\rho q),</span>
<span class="sd">        F_{z} = w (\rho q)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    quantity: str or iris.Constraint</span>
<span class="sd">        Quantity (present in the cube list).</span>
<span class="sd">    axis: str</span>
<span class="sd">        Axis of the flux component (x|y|z)</span>
<span class="sd">    weight_by_density: bool, optional</span>
<span class="sd">        Multiply by air density (must be present in the input cube list).</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of a flux component with the same dimensions as input cubes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*</span> <span class="n">q</span>
    <span class="k">if</span> <span class="n">weight_by_density</span><span class="p">:</span>
        <span class="n">fl</span> <span class="o">*=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span>
    <span class="n">fl</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flux_of_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">_along_</span><span class="si">{</span><span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_axis&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fl</span></div>



<div class="viewcode-block" id="toa_cloud_radiative_effect">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.toa_cloud_radiative_effect">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;W m-2&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">toa_cloud_radiative_effect</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate domain-average TOA cloud radiative effect (CRE).</span>

<span class="sd">    .. math::</span>
<span class="sd">        CRE_{TOA} = F_{up,clear-sky} - F_{up,all-sky}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes</span>
<span class="sd">    kind: str</span>
<span class="sd">        Shortwave (&#39;sw&#39;), longwave (&#39;lw&#39;), or &#39;total&#39; CRE</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of CRE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;toa_cloud_radiative_effect_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;sw&quot;</span><span class="p">:</span>
        <span class="n">all_sky</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">toa_osr</span>
        <span class="n">clr_sky</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">toa_osr_cs</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span>
        <span class="n">all_sky</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">toa_olr</span>
        <span class="n">clr_sky</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">toa_olr_cs</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span>
        <span class="n">sw</span> <span class="o">=</span> <span class="n">toa_cloud_radiative_effect</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">toa_cloud_radiative_effect</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">cre</span> <span class="o">=</span> <span class="n">sw</span> <span class="o">+</span> <span class="n">lw</span>
        <span class="n">cre</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cre</span>

    <span class="n">cube_clr</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">clr_sky</span><span class="p">)</span>
    <span class="n">cube_all</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">all_sky</span><span class="p">)</span>
    <span class="n">cre</span> <span class="o">=</span> <span class="n">cube_clr</span> <span class="o">-</span> <span class="n">cube_all</span>
    <span class="n">cre</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cre</span></div>



<div class="viewcode-block" id="toa_net_energy">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.toa_net_energy">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;toa_net_downward_energy_flux&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;W m-2&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">toa_net_energy</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate domain-average TOA energy flux.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of total TOA downward energy flux.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">model</span><span class="o">.</span><span class="n">toa_isr</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">toa_osr</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">toa_olr</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">varnames</span><span class="si">}</span><span class="s2"> required for TOA energy balance&quot;</span>
            <span class="s2">&quot; are missing from cubelist:</span><span class="se">\n</span><span class="si">{cubelist}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">terms_ave</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
        <span class="n">terms_ave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="n">toa_net</span> <span class="o">=</span> <span class="n">terms_ave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">terms_ave</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">terms_ave</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">toa_net</span></div>



<div class="viewcode-block" id="sfc_net_energy">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.sfc_net_energy">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;surface_net_downward_energy_flux&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;W m-2&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sfc_net_energy</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate domain-average surface energy flux.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input cubes with net LW and SW, sensible and latent surface fluxes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of total surface downward energy flux.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">net_down_lw</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sfc_net_down_lw</span><span class="p">)</span>
    <span class="n">net_down_sw</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sfc_net_down_sw</span><span class="p">)</span>
    <span class="n">shf</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sfc_shf</span><span class="p">)</span>
    <span class="n">lhf</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sfc_lhf</span><span class="p">)</span>
    <span class="n">sfc_net</span> <span class="o">=</span> <span class="n">net_down_lw</span> <span class="o">+</span> <span class="n">net_down_sw</span> <span class="o">-</span> <span class="n">shf</span> <span class="o">-</span> <span class="n">lhf</span>
    <span class="k">return</span> <span class="n">sfc_net</span></div>



<div class="viewcode-block" id="sfc_water_balance">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.sfc_water_balance">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;surface_net_downward_water_flux&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;mm h-1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sfc_water_balance</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate domain-average precipitation minus evaporation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have a scalar cube of `condensible_density` as an attribute.</span>
<span class="sd">        If not given, attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of total surface downward water flux (P-E).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">evap</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sfc_evap</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lhf</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sfc_lhf</span><span class="p">)</span>
            <span class="n">evap</span> <span class="o">=</span> <span class="n">lhf</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">condensible_heat_vaporization</span>
            <span class="n">evap</span> <span class="o">/=</span> <span class="n">const</span><span class="o">.</span><span class="n">condensible_density</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">ConMisErr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot retrieve evaporation from</span><span class="se">\n</span><span class="si">{</span><span class="n">cubelist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">precip</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ppn</span><span class="p">)</span>
        <span class="n">precip</span> <span class="o">/=</span> <span class="n">const</span><span class="o">.</span><span class="n">condensible_density</span>
    <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
        <span class="n">precip</span> <span class="o">=</span> <span class="n">precip_sum</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">const</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">precip</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;mm h-1&quot;</span><span class="p">)</span>
    <span class="n">evap</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;mm h-1&quot;</span><span class="p">)</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">precip</span> <span class="o">-</span> <span class="n">evap</span>
    <span class="k">return</span> <span class="n">net</span></div>



<div class="viewcode-block" id="precip_sum">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.precip_sum">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">precip_sum</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a sum of different types of precipitation [:math:`mm~day^{-1}`].</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    ptype: str, optional</span>
<span class="sd">        Precipitation type (total|stra|conv|rain|snow).</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have a scalar cube of `condensible_density` as an attribute.</span>
<span class="sd">        If not given, attempt to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Sum of cubes of precipitation with units converted to mm per day.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">_precip_name_mapping</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)[</span><span class="n">ptype</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown ptype=</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">varnames</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingCubeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">varnames</span><span class="si">}</span><span class="s2"> required for ptype=</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;are missing from cubelist:</span><span class="se">\n</span><span class="si">{cubelist}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">precip</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">cv_rain</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cv_snow</span><span class="p">]:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">precip</span> <span class="o">+=</span> <span class="n">cube</span>
        <span class="k">except</span> <span class="n">ConMisErr</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">precip</span> <span class="o">/=</span> <span class="n">const</span><span class="o">.</span><span class="n">condensible_density</span>
    <span class="n">precip</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;mm day-1&quot;</span><span class="p">)</span>
    <span class="n">precip</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2">_precip_rate&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">precip</span></div>



<div class="viewcode-block" id="heat_redist_eff">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.heat_redist_eff">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;heat_redistribution_efficiency&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">heat_redist_eff</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">region_a</span><span class="p">,</span> <span class="n">region_b</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Heat redistribution efficiency (Leconte et al. 2013).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \eta=\frac{OLR_{TOA,night}}{OLR_{TOA,day}}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    region_a: aeolus.region.Region</span>
<span class="sd">        First region (usually nightside).</span>
<span class="sd">    region_b: aeolus.region.Region</span>
<span class="sd">        Second region (usually dayside).</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of eta parameter with collapsed spatial dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">toa_olr</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">toa_olr</span><span class="p">)</span>
    <span class="n">toa_olr_a</span> <span class="o">=</span> <span class="n">spatial_mean</span><span class="p">(</span><span class="n">toa_olr</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">region_a</span><span class="o">.</span><span class="n">constraint</span><span class="p">))</span>
    <span class="n">toa_olr_b</span> <span class="o">=</span> <span class="n">spatial_mean</span><span class="p">(</span><span class="n">toa_olr</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">region_b</span><span class="o">.</span><span class="n">constraint</span><span class="p">))</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">toa_olr_a</span> <span class="o">/</span> <span class="n">toa_olr_b</span>
    <span class="k">return</span> <span class="n">eta</span></div>



<div class="viewcode-block" id="toa_eff_temp">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.toa_eff_temp">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;toa_effective_temperature&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">toa_eff_temp</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate effective temperature from TOA OLR.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of :math:`T_{eff}`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">toa_olr</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">toa_olr</span><span class="p">)</span>
    <span class="n">sbc</span> <span class="o">=</span> <span class="n">init_const</span><span class="p">()</span><span class="o">.</span><span class="n">stefan_boltzmann</span>
    <span class="n">t_eff</span> <span class="o">=</span> <span class="p">(</span><span class="n">toa_olr</span> <span class="o">/</span> <span class="n">sbc</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.25</span>
    <span class="k">return</span> <span class="n">t_eff</span></div>



<div class="viewcode-block" id="ghe_norm">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.ghe_norm">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;normalised_greenhouse_effect_parameter&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ghe_norm</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalised greenhouse effect parameter.</span>

<span class="sd">    .. math::</span>
<span class="sd">        GHE = 1 - \left(\frac{T_{eff}}{T_{sfc}}\right)^4</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of greenhouse effect parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t_sfc</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_sfc</span><span class="p">)</span>
    <span class="n">t_eff</span> <span class="o">=</span> <span class="n">toa_eff_temp</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_eff</span> <span class="o">/</span> <span class="n">t_sfc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="greenhouse_effect">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.greenhouse_effect">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;greenhouse_effect_parameter&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">greenhouse_effect</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;all_sky&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the greenhouse effect [K].</span>

<span class="sd">    .. math::</span>
<span class="sd">        GHE = T_{sfc} - \left(\frac{T_{eff}}{T_{sfc}}\right)^4</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    kind: str, optional</span>
<span class="sd">        Type of GHE:  &quot;all_sky&quot; or &quot;clear_sky&quot;</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of greenhouse effect parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t_sfc</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_sfc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;all_sky&quot;</span><span class="p">:</span>
        <span class="n">toa_olr</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">toa_olr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;clear_sky&quot;</span><span class="p">:</span>
        <span class="n">toa_olr</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">toa_olr_cs</span><span class="p">)</span>
    <span class="n">ghe</span> <span class="o">=</span> <span class="n">t_sfc</span> <span class="o">-</span> <span class="p">(</span><span class="n">toa_olr</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">stefan_boltzmann</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.25</span>
    <span class="k">return</span> <span class="n">ghe</span></div>



<div class="viewcode-block" id="bond_albedo">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.bond_albedo">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;bond_albedo&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bond_albedo</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bold albedo.</span>

<span class="sd">    .. math::</span>
<span class="sd">        4 \frac{OSR_{TOA}}{S_{0}}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Must have a scalar cube of `solar_constant` as an attribute.</span>
<span class="sd">        If not given, attempt to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of bond albedo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">toa_osr</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">toa_osr</span><span class="p">)</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">solar_constant</span>
    <span class="n">b_alb</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">toa_osr</span> <span class="o">/</span> <span class="n">sc</span>
    <span class="k">return</span> <span class="n">b_alb</span></div>



<div class="viewcode-block" id="water_path">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.water_path">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;kg m-2&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">water_path</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;water_vapour&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Water vapour or condensate path, i.e. a vertical integral of a water phase.</span>

<span class="sd">    .. math::</span>
<span class="sd">        WP = \int_{z_{sfc}}^{z_{top}} \rho q dz</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing mixing ratio and air density.</span>
<span class="sd">    kind: str, optional</span>
<span class="sd">        Short name of the water phase to be integrated.</span>
<span class="sd">        Options:</span>
<span class="sd">        water_vapour (default) | liquid_water | ice_water | cloud_water</span>
<span class="sd">        where `cloud_water` is the sum of liquid and ice phases.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant coordinate names.</span>
<span class="sd">        `model.z` is used as a vertical coordinate for integration.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of water path with collapsed vertical dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;water_vapour&quot;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">sh</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;liquid_water&quot;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cld_liq_mf</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;ice_water&quot;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cld_ice_mf</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;cloud_water&quot;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cld_liq_mf</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">+=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cld_ice_mf</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">rho</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">_path&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wp</span></div>



<div class="viewcode-block" id="dry_lapse_rate">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.dry_lapse_rate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dry_lapse_rate</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dry lapse rate, or the change of air temperature with altitude.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \gamma = \partial T_{air} / \partial z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes containing temperature.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube of dT/dz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d_dz</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span></div>



<div class="viewcode-block" id="horiz_wind_cmpnts">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.horiz_wind_cmpnts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">horiz_wind_cmpnts</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract u and v winds and interpolate v on u&#39;s grid if necessary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        List of cubes with horizontal wind components</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    u, v: iris.cube.Cube</span>
<span class="sd">        Cubes of wind components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># use relaxed extracting</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">u</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># interpolate v on u&#39;s grid if coordinates are different</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">regrid_3d</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span></div>



<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;local_superrotation_index&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">superrotation_index</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local superrotation index.</span>

<span class="sd">    .. math::</span>
<span class="sd">        s = \frac{m}{\Omega a^2} - 1,</span>

<span class="sd">        m = a cos\phi(\Omega a cos\phi + u)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        List of cubes containing a cube of zonal velocity (u).</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        Constainer with the relevant planetary constants.</span>
<span class="sd">        If not given, attempt is made to retrieve it from cube attributes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s_idx: iris.cube.Cube</span>
<span class="sd">        Cubes of superrotation index.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Read (1986), https://doi.org/10.1002/qj.49711247114</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Zonal velocity</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
    <span class="c1"># Radius of the planet</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">radius</span>
    <span class="n">r</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="c1"># Rotation rate</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">planet_rotation_rate</span>

    <span class="n">lat_coord</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">lat_dim</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">coord_dims</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lat_coord</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;radians&quot;</span><span class="p">)</span>
    <span class="n">lat_cos_coord</span> <span class="o">=</span> <span class="n">_coord_cos</span><span class="p">(</span><span class="n">lat_coord</span><span class="p">)</span>

    <span class="c1"># Calculate intermediate terms</span>
    <span class="n">omega_r_coslat</span> <span class="o">=</span> <span class="n">omega</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">lat_cos_coord</span>
    <span class="n">omega_r_coslat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;m s-1&quot;</span><span class="p">)</span>
    <span class="n">r_coslat</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">lat_cos_coord</span>
    <span class="n">r_coslat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="n">inner_sum</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">omega_r_coslat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">lat_dim</span><span class="p">)</span>

    <span class="c1"># Calculate axial component of specific absolute angular momentum</span>
    <span class="n">ang_mom</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">inner_sum</span><span class="p">,</span> <span class="n">r_coslat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">lat_dim</span><span class="p">)</span>

    <span class="c1"># Final index</span>
    <span class="n">s_idx</span> <span class="o">=</span> <span class="n">ang_mom</span> <span class="o">/</span> <span class="n">omega</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">s_idx</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">s_idx</span> <span class="o">=</span> <span class="n">s_idx</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">s_idx</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s_idx</span>


<div class="viewcode-block" id="wind_speed">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.wind_speed">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;wind_speed&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m s-1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wind_speed</span><span class="p">(</span><span class="o">*</span><span class="n">components</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the wind speed (magnitude of the wind vector).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \sqrt{u^2 + v^2 + w^2}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args: iris.cube.Cube</span>
<span class="sd">        Cubes of u, v, w wind components.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cube</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">cube</span> <span class="ow">in</span> <span class="n">components</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="sigma_p">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.sigma_p">[docs]</a>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;atmosphere_hybrid_sigma_pressure_coordinate&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sigma_p</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate sigma (normalised pressure coordinate) from a cube of pressure.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \sigma = p / p_{sfc}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input list of cubes.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pres_atm</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
    <span class="n">pres_sfc</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">p_sfc</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pres_atm</span> <span class="o">/</span> <span class="n">pres_sfc</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="zonal_mass_streamfunction">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.zonal_mass_streamfunction">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;zonal_mass_streamfunction&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;kg s^-1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">zonal_mass_streamfunction</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate mean zonal mass streamfunction.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \Psi_Z=2\pi a\int_{z_{sfc}}^{z_{top}}\overline{\rho}^*\overline{u}^* dz</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Haqq-Misra &amp; Kopparapu (2015), eq. 5;</span>
<span class="sd">    Hartmann (1994), Global Physical Climatology, eq. 6.21</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; lat_band_constr = iris.Constraint(</span>
<span class="sd">        latitude=lambda x: -30 &lt;= x.point &lt;= 30, longitude=lambda x: True</span>
<span class="sd">    )</span>
<span class="sd">    &gt;&gt;&gt; mzsf = zonal_mass_streamfunction(cubes.extract(lat_band_constr))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">streamf_const</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">radius</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
    <span class="n">u_tm</span> <span class="o">=</span> <span class="n">time_mean</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_tm</span> <span class="o">-</span> <span class="n">zonal_mean</span><span class="p">(</span><span class="n">u_tm</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">):</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">time_mean</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">u</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*</span> <span class="n">rho</span>
        <span class="c1"># integrand = reverse(integrand, model.z)</span>
        <span class="c1"># print(integrand.coord(um.z))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">axis_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># res = cumsum(integrand, &quot;z&quot;, axis_weights=True, model=model)</span>
        <span class="c1"># res = reverse(res, model.z)</span>

    <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;Pa&quot;</span><span class="p">):</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">axis_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">/=</span> <span class="n">const</span><span class="o">.</span><span class="n">gravity</span>

    <span class="n">res</span> <span class="o">*=</span> <span class="n">streamf_const</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="meridional_mass_streamfunction">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.meridional_mass_streamfunction">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="nd">@update_metadata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;meridional_mass_streamfunction&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;kg s^-1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">meridional_mass_streamfunction</span><span class="p">(</span><span class="n">cubelist</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the mean meridional mass streamfunction.</span>

<span class="sd">    * In height coordinates</span>

<span class="sd">    .. math::</span>
<span class="sd">        \Psi_M = - 2\pi cos\phi a \int_{z_{sfc}}^{z_{top}}\overline{\rho v} dz</span>

<span class="sd">    * In pressure coordinates</span>

<span class="sd">    .. math::</span>
<span class="sd">        \Psi_M = 2\pi cos\phi a \int_{0}^{p_{sfc}}\overline{v} dp / g</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cubelist: iris.cube.CubeList</span>
<span class="sd">        Input cubelist.</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        If not given, constants are attempted to be retrieved from</span>
<span class="sd">        attributes of a cube in the cube list.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    iris.cube.Cube</span>
<span class="sd">        Cube with collapsed spatial dimensions.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Haqq-Misra &amp; Kopparapu (2015), eq. 4;</span>
<span class="sd">    Vallis (2017)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from aeolus.calc import meridional_mass_streamfunction, time_mean</span>
<span class="sd">    &gt;&gt;&gt; from aeolus.const import init_const</span>
<span class="sd">    &gt;&gt;&gt; from aeolus.model import um</span>
<span class="sd">    &gt;&gt;&gt; earth_constants = init_const(&quot;earth&quot;)</span>
<span class="sd">    &gt;&gt;&gt; cubes = iris.cube.CubeList([time_mean(cube) for cube in input_cubes])</span>
<span class="sd">    &gt;&gt;&gt; mmsf = meridional_mass_streamfunction(cubes, const=earth_constants)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">zonal_mean</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">):</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">zonal_mean</span><span class="p">(</span><span class="n">cubelist</span><span class="o">.</span><span class="n">extract_cube</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dens</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">rho</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">v</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Reverse the coordinate to start from the top (where p=0 or z=z_top)</span>
        <span class="c1"># TODO: check if the coordinate is ascending or descending</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">rho</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">axis_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># Reverse the result back</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_convertible</span><span class="p">(</span><span class="s2">&quot;Pa&quot;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">axis_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">/=</span> <span class="n">const</span><span class="o">.</span><span class="n">gravity</span>
    <span class="c1"># Calculate the constant: 2 pi cos\phi a</span>
    <span class="n">streamf_const</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="n">lat_cos</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">*=</span> <span class="n">streamf_const</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="wind_rot_div">
<a class="viewcode-back" href="../../../api/calc.html#aeolus.calc.diag.wind_rot_div">[docs]</a>
<span class="nd">@const_from_attrs</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wind_rot_div</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">um</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split the horizontal wind field into divergent and rotational parts.</span>

<span class="sd">    The Helmholtz decomposition method uses the `windspharm` library:</span>
<span class="sd">    https://ajdawson.github.io/windspharm/latest/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    u: iris.cube.Cube</span>
<span class="sd">        Eastward wind.</span>
<span class="sd">    v: iris.cube.Cube</span>
<span class="sd">        Northward wind.</span>
<span class="sd">    truncation: int</span>
<span class="sd">        Truncation for the spherical harmonic computation</span>
<span class="sd">        (See windspharm docs for details).</span>
<span class="sd">    const: aeolus.const.const.ConstContainer, optional</span>
<span class="sd">        If not given, constants are attempted to be retrieved from</span>
<span class="sd">        attributes of a cube in the cube list.</span>
<span class="sd">    model: aeolus.model.Model, optional</span>
<span class="sd">        Model class with relevant variable names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out: dict</span>
<span class="sd">        Dictionary of cubes of:</span>
<span class="sd">          - input wind components (for convenience),</span>
<span class="sd">          - divergent components,</span>
<span class="sd">          - rotational components,</span>
<span class="sd">          - zonal mean rotational components,</span>
<span class="sd">          - zonal eddy rotational components.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Hammond and Lewis (2021), https://doi.org/10.1073/pnas.2022705118.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">windspharm.iris</span><span class="w"> </span><span class="kn">import</span> <span class="n">VectorWind</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">VectorWind</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">rsphere</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">div_cmpnt_u</span><span class="p">,</span> <span class="n">div_cmpnt_v</span><span class="p">,</span> <span class="n">rot_cmpnt_u</span><span class="p">,</span> <span class="n">rot_cmpnt_v</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">helmholtz</span><span class="p">(</span>
        <span class="n">truncation</span><span class="o">=</span><span class="n">truncation</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;u_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;v_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;u_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">div_cmpnt_u</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;v_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">div_cmpnt_v</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;u_rot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">rot_cmpnt_u</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;v_rot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">rot_cmpnt_v</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cmpnt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]:</span>
        <span class="n">rot_cmpnt</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmpnt</span><span class="si">}</span><span class="s2">_rot&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmpnt</span><span class="si">}</span><span class="s2">_rot_zm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preserve_shape</span><span class="p">(</span><span class="n">zonal_mean</span><span class="p">)(</span><span class="n">rot_cmpnt</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmpnt</span><span class="si">}</span><span class="s2">_rot_zm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;zonal_mean_of_</span><span class="si">{</span><span class="n">rot_cmpnt</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmpnt</span><span class="si">}</span><span class="s2">_rot_eddy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_cmpnt</span> <span class="o">-</span> <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmpnt</span><span class="si">}</span><span class="s2">_rot_zm&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmpnt</span><span class="si">}</span><span class="s2">_rot_eddy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;zonal_deviation_of_</span><span class="si">{</span><span class="n">rot_cmpnt</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2020 - 2026, aeolus contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=4db31e98"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>